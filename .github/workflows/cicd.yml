name: .NET

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.101
    - name: Restore dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --configuration Release --no-restore
    - name: Publish
      run: dotnet publish --configuration Release -o './dist'
    
    - name: Archive Action
      # You may pin to the exact commit or the version.
      # uses: ihiroky/archive-action@e8b4644f992de8f7423e0bd7292c2e047ecf26ce
      uses: ihiroky/archive-action@v1
      with:
        # Root directory.
        root_dir: './dist'
        # Base directory; common prefix of all files and directories in the archive, relative to root_dir.
        base_dir: ./dist # optional, default is .
        # Output file path. Supported extensions: zip, tar, tar.gz(tgz), tar.bz2(tbz2), tar.xz(txz)
        file_path: output.zip # optional, default is output.zip
        # Shows details about the result of running this action.
        verbose: # optional

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: AWS Deploy S3
      # You may pin to the exact commit or the version.
      # uses: oneyedev/aws-deploy-s3@16e61e78e12904502d31e6c4adbe1f7d58eddaa7
      uses: oneyedev/aws-deploy-s3@v2
      with:
        # AWS Region of S3 Bucket
        region: us-east-1  # default is us-east-1
        # Name of S3 Bucket
        bucket: code-deploy-bucket-ykim
        # A Local Source Directory to Upload
        source: ./dist/output.zip # default is ./dist
        # A Remote Target Directory to Upload
        target: GitHubActions # default is 
    
    - name: Sourcetoad - AWS CodeDeploy for GitHub Actions
      # You may pin to the exact commit or the version.
      # uses: sourcetoad/aws-codedeploy-action@62597bb4ecbcd206477fdc54665e214fdc2e9cfd
      uses: sourcetoad/aws-codedeploy-action@v1.0.4
      with:
        s3_bucket: code-deploy-bucket-ykim
        # S3 Folder for ZIP.
        s3_folder: GitHubActions
        # Directory to be archived instead of entire workspace.
        directory: # optional
        # Files to be excluded during archiving (space delimited).
        excluded_files: # optional
        # AWS CodeDeploy Application Name
        codedeploy_name: DemoCoreApp
        # AWS CodeDeploy Application Group
        codedeploy_group: Pre-Deployment-Group
        # Whether to register the deployment (vs automatic deploy).
        codedeploy_register_only: # optional, default is false
        # Max amount of iterations (15s increments) to wait for a deployment
        max_polling_iterations: # optional, default is 60